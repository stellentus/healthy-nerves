\documentclass[12pt]{article}
\fontfamily{ptm}\selectfont

\usepackage{setspace} \doublespacing
\usepackage[margin=1.2in]{geometry}  % set the margins
\usepackage{graphicx}              % to include figures
\usepackage{epstopdf}
\usepackage{amsmath}               % great math stuff
\usepackage{amsfonts}              % for blackboard bold, etc
\usepackage{amsthm}                % better theorem environments
\usepackage{titlesec}

\linespread{1}

\usepackage{caption}
\captionsetup[figure]{labelsep=space}

\usepackage{authblk}
\title{Batch Effects Summary}
\author{James M Bell}
\renewcommand\Affilfont{\itshape\small}

\begin{document}

\maketitle

\section*{Introduction and Methods}

The data comes from three electrodiagnostic nerve excitability test (NET) datasets (median nerve, i.e. arm) from Canada (n=120), Japan (n=85), and Portugal (n=42). Additionally, some trials used a Canadian common peroneal nerve (i.e. leg) dataset (n=121), a rat dataset (n=49), and a spinal cord injury (SCI) dataset (n=13). The data as analyzed here consists of 30 real-valued measures (age, temperature, and 28 excitability variables) and one categorical measure (male/female) extracted from the NET datasets.

% Defend use of NMI.

In all of the following tests, two or more datasets were combined. The normalized mutual information (NMI) was calculated based on a random sample of 80\% of the combined dataset, reported as mean (standard deviation) across 30 different random samples. A different random seed was used for each of the 30 trials, but the same 30 seeds were used for each test in a given figure.

Normalized mutual information can be used to compare two clusterings (or known labels and a clustering) to measure how similar they are. A score of 0 indicates no similarity, while 1 indicates they are identical. Therefore, NMI for the combined Canadian/Japanese/Portuguese dataset should be near 0 if it is appropriate to combine them into a normative dataset, while any combination with leg, rat, or SCI data should be significantly higher. NMI is normalized to account for different numbers of clusters, so it is appropriate to compare it even when the number of groups is different.

The data was normalized before the NMI was calculated by combining the data (across all labels) and converting it to zero mean, unit variance.

\emph{My doubts and concerns are emphasized like this.}

\pagebreak

\section*{Results and Some Discussion}

\begin{figure*}[ht]
  \centering
       \includegraphics[width=\textwidth]{../img/batch-norm-rand.png}
         \caption{}
  \label{fig:norm-rand}
\end{figure*}

In Figure 1, NMI for the normative dataset (i.e. combined Canadian, Japanese, and Portuguese data) is compared to two different randomly generated lists of three labels with a length of 247. (NMI for identical lists is always exactly 1, so it is not shown.) As expected, NMI for random data is near zero. The normative data is not quite zero, indicating potential (but small) batch effects.

% TODO I can't explain why the mean trends up. Why is there an effect of group size?

\pagebreak

\begin{figure*}
  \centering
       \includegraphics[width=\textwidth]{../img/batch-group-size.png}
         \caption{}
  \label{fig:group-size}
\end{figure*}

All of the results in Figure \ref{fig:norm-rand} used three labels, but future figures will not. While NMI theory allows for comparison of NMI with different numbers of clusters, it is illustrative to present a visual comparison of diverse cluster sizes (Figure \ref{fig:group-size}). In this set of tests, one or more of the datasets was randomly divided in half to increase the number of clusters. (The same split was used for all 30 iterations.) For example, Canadian data (n=120) was randomly split into Canadian data A (n=60) and B (n=60) and then combined with Japanese (n=85) and Portuguese (n=42) data to measure NMI with 4 clusters.

\emph{With random data, it looks to me like as the number of clusters increases, the mean and standard deviation get smaller (approach zero). So with data that has no batch effects, I think increased clusters would follow the same pattern?}

\emph{If data has 3 strongly-batched groups, I would expect that splitting that into 9 groups would decrease the NMI. Within each cluster (where there are no batch effects) we have now created 3 groups, but the cluster-internal NMI would be 0 (if we were to calculate it on just the 3 sub-groups of one cluster), so I suspect the overall NMI would be reduced as a result. I should probably test this so I can more easily explain Figure \ref{fig:group-size}. (Along the same lines, there's a difference between splitting one label into two labels or adding an entirely new label and associated data. I'm not entirely sure which one is theoretically not going to change NMI; I assume the former.)}

\pagebreak

\begin{figure*}
  \centering
       \includegraphics[width=\textwidth]{../img/batch-vs-countries.png}
         \caption{}
  \label{fig:vs-countries}
\end{figure*}

% TODO

\pagebreak

\begin{figure*}
  \centering
       \includegraphics[width=\textwidth]{../img/batch-vs-countries.png}
         \caption{}
  \label{fig:vs-countries}
\end{figure*}

Figure \ref{fig:vs-countries} shows the effect of comparing normative datasets composed of two countries' data vs the other country (i.e. two labels). For example, the first result shows the BVI for a normative dataset of Japan and Portugal compared to Canada. The second results shows the theoretical minimum for two groups of the same sizes. This result shows that no country's data is significantly worse than the others'. Japanese data does appear to be similar to the combined Canadian/Portuguese data. \emph{I have no idea what to conclude here.}

\pagebreak

\begin{figure*}
  \centering
       \includegraphics[width=\textwidth]{../img/batch-rc.png}
         \caption{}
  \label{fig:rc}
\end{figure*}

To be confident in the normative data it was necessary to show a near-zero NMI, but that is not sufficient. The NMI must also change significantly when non-normative data is added. To test the impact of widespread changes, 6 of the 28 excitability variables were subtly adjusted (see Figure \ref{fig:rc}). In the ``RC shift'' tests, the 7 variables derived from one portion of the NET (recovery cycle, RC) were transformed in one of the three datasets as if the corresponding underlying data had shifted left or right, imitating a plausible technical difference between datasets. In the ``RC shrink'' tests, those same 7 variables were decreased by 50\%. The results show a \emph{(probably not significant?)} small increase in NMI.

% TODO note shifting RC only changes 3 parameters, while shrinking changes 7.
% Maybe show what the shift looks like. Logarithmic or what?
% Note the shift really only impacts measures from the first 20ms, so this is a bad test.
% Maybe shift TE up or down.
% Maybe in my thesis I can use this as a point about updating the list of excitability indices. Can I suggest in the future a reason or way to dispose of the excitability measures in favor of the entire waveform (or I think a different set from feature selection). As part of this I could show two people with identical excitability measures, but with different waveforms after 50ms.

\pagebreak

\begin{figure*}
  \centering
       \includegraphics[width=\textwidth]{../img/batch-vs-legs.png}
         \caption{}
  \label{fig:vs-legs}
\end{figure*}

Testing with simulated batches shows some minor increases to NMI. It will also be illustrative to consider batch effects between the normative data and some other datasets. Leg data is similar to arm data, but it is different enough that it should show up as a different batch. In Figure \ref{fig:vs-legs}, the the Canadian median nerve (arm) data is replaced with with CP nerve (leg) data (labeled as \textbf{Can Arms $\rightarrow$ Legs}). This causes a significant NMI increase, as expected. Adding the leg data (\textbf{Add Legs}) results in 4 groups. Now one quarter of the data is from legs instead of one third as in the previous test, so it is expected to calculate an NMI score lower than the last trial but higher than the normative data. Finally, comparing all of the normative data (from all three countries labelled together) to the leg data (\textbf{Normative vs Legs}) shows the legs are obviously a different batch. Also note the NMI when comparing legs to Portugal to Japan (0.26$\pm$0.06) is quite similar to the NMI when comparing legs to all three countries  (0.25$\pm$0.07), suggesting the Canadian data is similar to the other arm data.

\pagebreak

\begin{figure*}
  \centering
       \includegraphics[width=\textwidth]{../img/batch-vs-rats.png}
         \caption{}
  \label{fig:vs-rats}
\end{figure*}

Rat data is radically different from human, so it should be even more clearly a different batch than a comparison to leg data.  Figure \ref{fig:vs-rats} compares NMI for datasets between these groups. Replacing the Canadian or Japanese data with rat data causes a large increase in NMI. Adding rat data to the three normative groups has a slightly smaller impact on NMI (since rat data is now one of four groups instead of one of three groups). Finally, when the normative human median data is compared to the diverse rat data, the NMI score approaches its maximum value, indicating a clear difference between species (in spite of the heterogeneity of the rat data).

\pagebreak

\section*{More Discussion and Conclusions}

Figures \ref{fig:rc}â€“\ref{fig:vs-rats} show that NMI is an effective measure for detecting batch effects. The normative data NMI was 0.06$\pm$0.03. When compared to legs, it quadrupled to 0.24$\pm$0.07. When compared to rats, it increased to 0.99$\pm$0.02. This indicates that normative human arm data is somewhat distinguishable from leg data and very distinguishable from rat data, so NMI can be used to determine if NET data from diverse sources can be appropriately combined. NMI is sensitive to large changes (e.g. leg or rat), though it may not be sensitive to smaller, biologically-plausible changes. These results suggest that there are no large batch effects between the Canadian, Japanese, and Portuguese data. If batch effects exist, they must be small.

\emph{I suspect if the majority of the parameters changed by 50\%, I wouldn't detect it, so I'm not sure this really counts as ``small''. Also, see the note above about different anaesthetics or motor axon types.}

Future work could consider what makes legs easy to distinguish from arms (or rats from humans) while differences between rat motor axon types or anaesthetics are not so pronounced. This would give more insight into potential differences between the Canadian, Japanese, and Portuguese datasets.

\end{document}
